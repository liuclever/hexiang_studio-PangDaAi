<!--pages/attendance/activity/index.wxml-->
<view class="container">
  <!-- 页面头部 -->
  <view class="page-header">
    <view class="nav-section-centered">
      <text class="page-title-centered">活动考勤</text>
    </view>
    
    <!-- 筛选栏 -->
    <view class="filter-bar">
      <view class="filter-chips">
        <view class="chip {{filter === 'all' ? 'active' : ''}}" bindtap="setFilter" data-filter="all">
          全部活动
        </view>
        <view class="chip {{filter === 'ongoing' ? 'active' : ''}}" bindtap="setFilter" data-filter="ongoing">
          进行中
        </view>
        <view class="chip {{filter === 'upcoming' ? 'active' : ''}}" bindtap="setFilter" data-filter="upcoming">
          即将开始
        </view>
        <view class="chip {{filter === 'ended' ? 'active' : ''}}" bindtap="setFilter" data-filter="ended">
          已结束
        </view>
      </view>
    </view>
    
    <!-- 创建按钮 (仅管理员) -->
    <view wx:if="{{userRole === 'admin'}}" class="action-bar">
      <button class="create-btn" bindtap="showCreateForm">
        <t-icon name="add" size="32rpx" color="#ffffff"></t-icon>
        创建活动考勤
      </button>
    </view>
  </view>

  <!-- 活动列表 -->
  <view class="activity-list">
    <view wx:if="{{filteredActivities.length === 0}}" class="empty-state">
      <t-icon name="inbox" size="120rpx" color="#cccccc" class="empty-icon"></t-icon>
      <text class="empty-text">暂无{{filterWxs.getFilterText(filter)}}活动</text>
    </view>
    
    <view wx:for="{{filteredActivities}}" wx:key="planId" class="activity-card" bindtap="viewActivityDetail" data-activity="{{item}}">
      <view class="activity-card-content">
        <view class="activity-header">
          <view class="activity-title-row">
            <text class="activity-title">{{item.name}}</text>
            <view class="status-indicator {{item.status}}">
              {{item.statusText}}
            </view>
          </view>
          
          <view class="activity-meta">
            <view class="time-info">
              <text class="time-label">时间:</text>
              <text class="time-value">{{tools.formatDateTime(item.startTime)}} - {{tools.formatDateTime(item.endTime)}}</text>
            </view>
            <view class="location-info">
              <text class="location-label">地点:</text>
              <text class="location-value">{{item.location}}</text>
            </view>
          </view>
        </view>
        
        <view class="activity-body">
          <view wx:if="{{item.note}}" class="activity-desc">
            {{tools.truncateText(item.note, 80)}}
          </view>
          
          <view class="activity-stats">
            <view class="stat-item">
              <text class="stat-value">{{item.attendanceCount || 0}}/{{item.totalStudents || 0}}</text>
              <text class="stat-label">已签到</text>
            </view>
            <view class="stat-divider"></view>
            <view class="stat-item">
              <text class="stat-value">{{tools.formatLocation(item.location, item.locationLat, item.locationLng)}}</text>
              <text class="stat-label">签到区域</text>
            </view>
            <view class="stat-divider"></view>
            <view class="stat-item">
              <text class="stat-value">{{item.statusText}}</text>
              <text class="stat-label">活动状态</text>
            </view>
          </view>
        </view>
        
        <view class="activity-footer">
          <view class="footer-left">
            <text class="creator">创建者: {{item.createUserName || '系统'}}</text>
          </view>
          <view class="footer-right">
            <button class="sign-btn" bindtap="viewActivityDetail" data-activity="{{item}}" catchtap="true">
              查看详情
            </button>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- 创建活动弹窗 -->
<view wx:if="{{showCreateForm}}" class="edit-form-overlay" bindtap="hideCreateForm">
  <view class="edit-form-modal" catchtap="preventClose">
    <view class="edit-form-header">
      <text class="edit-form-title">创建活动考勤</text>
      <t-icon name="close" size="32rpx" color="#999" bindtap="hideCreateForm" />
    </view>
    
    <scroll-view scroll-y="true" class="edit-form-content">
      <view class="form-item">
        <text class="form-label">考勤名称</text>
        <input class="form-input" placeholder="请输入考勤名称" value="{{createForm.name}}" bindinput="onCreateNameInput" />
      </view>
      
      <view class="form-item">
        <text class="form-label">开始时间</text>
        <picker mode="multiSelector" range="{{dateTimeRange}}" value="{{startTimeIndex}}" bindchange="onCreateStartTimeChange" class="form-picker">
          <view class="picker-display">{{createForm.startTimeDisplay || '请选择开始时间'}}</view>
        </picker>
      </view>
      
      <view class="form-item">
        <text class="form-label">结束时间</text>
        <picker mode="multiSelector" range="{{dateTimeRange}}" value="{{endTimeIndex}}" bindchange="onCreateEndTimeChange" class="form-picker">
          <view class="picker-display">{{createForm.endTimeDisplay || '请选择结束时间'}}</view>
        </picker>
      </view>
      
      <view class="form-item">
        <text class="form-label">活动地点</text>
        <picker range="{{commonLocations}}" range-key="name" value="{{createForm.locationIndex}}" bindchange="onCreateLocationChange" class="form-picker">
          <view class="picker-display">{{createForm.locationDisplay || '请选择活动地点'}}</view>
        </picker>
      </view>
      
      <view class="form-row">
        <view class="form-item half">
          <text class="form-label">纬度</text>
          <view class="form-display">{{createForm.locationLat ? tools.formatCoordinate(createForm.locationLat) : '请先选择地点'}}</view>
        </view>
        <view class="form-item half">
          <text class="form-label">经度</text>
          <view class="form-display">{{createForm.locationLng ? tools.formatCoordinate(createForm.locationLng) : '请先选择地点'}}</view>
        </view>
      </view>
      
      <view class="form-item">
        <text class="form-label">签到半径</text>
        <input class="form-input" type="number" placeholder="请输入签到半径(米)" value="{{createForm.radius}}" bindinput="onCreateRadiusInput" />
      </view>
      
      <view class="form-item">
        <text class="form-label">考勤状态</text>
        <picker range="{{statusOptions}}" range-key="label" value="{{createForm.statusIndex}}" bindchange="onCreateStatusChange" class="form-picker">
          <view class="picker-display">{{statusOptions[createForm.statusIndex].label}}</view>
        </picker>
      </view>
      
      <view class="form-item">
        <text class="form-label">参与学生 *</text>
        <view class="student-selector-container">
          <view class="student-selector-trigger" bindtap="showStudentSelector">
            <text class="selector-text">{{createForm.selectedStudents.length > 0 ? '已选择' + createForm.selectedStudents.length + '名学生' : '请选择参与学生'}}</text>
            <t-icon name="chevron-right" size="32rpx" color="#999" />
          </view>
          <view wx:if="{{createForm.selectedStudents.length > 0}}" class="selected-students-preview">
            <view wx:for="{{createForm.selectedStudents}}" wx:key="id" class="student-chip">
              <text class="student-name">{{item.name}}</text>
              <t-icon name="close" size="24rpx" color="#666" bindtap="removeStudent" data-index="{{index}}" />
            </view>
          </view>
        </view>
      </view>

      <view class="form-item">
        <text class="form-label">备注说明</text>
        <textarea class="form-textarea" placeholder="请输入备注说明" value="{{createForm.note}}" bindinput="onCreateNoteInput"></textarea>
      </view>
    </scroll-view>
    
    <view class="edit-form-actions">
      <button class="form-btn cancel" bindtap="hideCreateForm">取消</button>
      <button class="form-btn confirm {{submitting ? 'loading' : ''}}" bindtap="submitCreate" disabled="{{submitting}}">
        {{submitting ? '创建中...' : '创建考勤'}}
      </button>
    </view>
  </view>
</view>

<!-- 学生选择器弹窗 -->
<view wx:if="{{showStudentSelector}}" class="student-selector-overlay" bindtap="hideStudentSelector">
  <view class="student-selector-modal" catchtap="preventClose">
    <view class="selector-header">
      <text class="selector-title">选择参与学生</text>
      <view class="selector-actions">
        <view class="action-btn confirm-btn" bindtap="confirmStudentSelection">
          <text>确定</text>
        </view>
      </view>
    </view>
    
    <view class="selector-search">
      <view class="search-bar">
        <view class="search-icon">
          <t-icon name="search" size="28rpx" color="#8c8c8c" />
        </view>
        <input 
          class="search-input" 
          placeholder="搜索学生姓名或学号" 
          value="{{studentSearchKeyword}}"
          bindinput="onStudentSearchInput"
          confirm-type="search"
        />
        <view wx:if="{{studentSearchKeyword}}" class="search-clear" bindtap="clearStudentSearch">
          <t-icon name="close-circle-filled" size="28rpx" color="#bfbfbf" />
        </view>
      </view>
    </view>
    
    <view class="selector-content">
      <!-- 学生选择区域 -->
      <view class="available-section">
        <view class="section-header">
          <view class="section-title-wrapper">
            <text class="section-title">选择学生</text>
            <view class="section-count">已选{{tempSelectedStudents.length}}人</view>
          </view>
          <view class="section-actions">
          <view class="section-action" bindtap="clearAllStudents">
              <text>清空</text>
            </view>
            <view class="section-action" bindtap="selectAllStudents">
              <text>全选</text>
            </view>
          </view>
        </view>
        <scroll-view class="available-list" scroll-y="true" bindscrolltolower="loadMoreStudents">
          <view wx:if="{{studentsLoading}}" class="loading-tip">
            <t-loading size="40rpx" />
            <text>加载中...</text>
          </view>
          
          <view class="students-grid">
            <view wx:for="{{filteredStudents}}" wx:key="id" class="student-grid-item {{tools.isStudentSelected(item.id, tempSelectedStudents) ? 'active' : ''}}" bindtap="toggleStudentSelection" data-student="{{item}}">
              <view class="student-info-compact">
                <text class="student-name-compact">{{item.name}}</text>
                <text wx:if="{{item.studentNumber}}" class="student-number-compact">{{item.studentNumber}}</text>
            </view>
              <view class="student-checkbox-compact {{tools.isStudentSelected(item.id, tempSelectedStudents) ? 'checked' : ''}}">
                <t-icon wx:if="{{tools.isStudentSelected(item.id, tempSelectedStudents)}}" name="check" size="16rpx" color="#fff" />
              </view>
            </view>
          </view>
          
          <view wx:if="{{filteredStudents.length === 0 && !studentsLoading}}" class="empty-tip">
            <t-icon name="user" size="80rpx" color="#ddd" />
            <text>{{studentSearchKeyword ? '未找到匹配的学生' : '暂无可选学生'}}</text>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>
</view>

<!-- 工具类 WXS 模块 -->
<wxs module="tools">
  // 格式化日期时间
  function formatDateTime(dateStr) {
    if (!dateStr) return '';
    var date = getDate(dateStr);
    return (date.getMonth() + 1) + '/' + date.getDate() + ' ' + 
           padZero(date.getHours()) + ':' + padZero(date.getMinutes());
  }
  
  // 补零
  function padZero(num) {
    return num < 10 ? '0' + num : num;
  }
  
  // 截断文本
  function truncateText(text, maxLength) {
    if (!text) return '';
    return text.length <= maxLength ? text : text.substring(0, maxLength) + '...';
  }
  
  // 检查学生是否已选择
  function isStudentSelected(studentId, selectedStudents) {
    if (!selectedStudents || selectedStudents.length === 0) return false;
    for (var i = 0; i < selectedStudents.length; i++) {
      if (selectedStudents[i].id === studentId) {
        return true;
      }
    }
    return false;
  }
  
  // 格式化位置显示
  function formatLocation(location, lat, lng) {
    if (location && location.trim()) {
      return location;
    }
    if (lat && lng) {
      return lat.toFixed(6) + ',' + lng.toFixed(6);
    }
    return '未设置';
  }
  
  // 格式化坐标，保留6位小数
  function formatCoordinate(coordinate) {
    if (!coordinate) return '';
    var num = parseFloat(coordinate);
    return num.toFixed(6);
  }
  
  module.exports = {
    formatDateTime: formatDateTime,
    truncateText: truncateText,
    isStudentSelected: isStudentSelected,
    formatLocation: formatLocation,
    formatCoordinate: formatCoordinate
  };
</wxs>

<wxs module="filterWxs">
  function getFilterText(filterType) {
    switch(filterType) {
      case 'ongoing': return '进行中的';
      case 'upcoming': return '即将开始的';
      case 'ended': return '已结束的';
      default: return '';
    }
  }
  
  module.exports = {
    getFilterText: getFilterText
  };
</wxs>

 