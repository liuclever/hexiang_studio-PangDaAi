<view class="container">
  <!-- 顶部标题栏 -->
  <view class="header">
    <view class="header-title">
      <text>何湘技能大师工作室</text>
    </view>
    <view class="header-subtitle">
      <text>高效管理工作室各项业务</text>
    </view>
    <view class="header-icons">
      <view class="icon-item" bindtap="openRoleModal">
        <image src="/images/icons/role-switch.png" mode="aspectFit"></image>
      </view>
      <view class="icon-item">
        <image src="/images/icons/notification.png" mode="aspectFit"></image>
      </view>
      <view class="icon-item">
        <image src="/images/icons/settings.png" mode="aspectFit"></image>
      </view>
    </view>
  </view>
  
  <!-- 数据概览卡片 -->
  <view class="stats-card card">
    <view class="stats-item">
      <view class="stats-label">
        <t-icon name="user" size="32rpx" color="#0052d9" style="margin-right: 8rpx;"></t-icon>
        当前在线
      </view>
      <view class="stats-value">{{statistics.activeToday}}</view>
    </view>
    <view class="stats-divider"></view>
    <view class="stats-item">
      <view class="stats-label">
        <t-icon name="education" size="32rpx" color="#0052d9" style="margin-right: 8rpx;"></t-icon>
        总课程数
      </view>
      <view class="stats-value">{{statistics.totalCourses}}</view>
    </view>
  </view>
  
  <!-- 管理员特有内容 -->
  <block wx:if="{{role === 'admin'}}">
    <view class="section-title">
      <text class="section-title-text">管理员工作台</text>
      <text class="more-text" bindtap="goToApprovalHistory">审批记录 ></text>
    </view>
    <view class="overview-card card" hover-class="card-hover" hover-stay-time="200" bindtap="goToApprovalRecords">
      <view class="overview-title">
        <text>工作室管理统计</text>
      </view>
      
      <view class="admin-stats">
        <view class="admin-stat-item approval-stat-item">
          <view class="stat-number pending">{{approvalStats.totalPendingApprovals}}</view>
          <view class="stat-label">待审批申请</view>
          <view class="stat-detail">{{approvalStats.pendingTaskSubmissions}}个任务 + {{approvalStats.pendingLeaveRequests}}个请假</view>
        </view>
        <view class="admin-stat-item">
          <view class="stat-number">{{approvalStats.todayProcessed}}</view>
          <view class="stat-label">今日已处理</view>
        </view>
      </view>
    </view>
  </block>
  
  <!-- 学生特有内容 -->
  <block wx:else>
    <view class="section-title">任务进度
      <text class="more-text" bindtap="viewAllTasks">查看全部 ></text>
    </view>
    <view class="overview-card card">
      <view class="overview-title">
        <text>我的任务进度</text>
      </view>
      
      <view class="student-progress">
        <view wx:if="{{taskProgress.length === 0}}" class="empty-progress">
          <t-icon name="inbox" size="100rpx" color="#cccccc"></t-icon>
          <text>暂无任务</text>
        </view>
        
        <view wx:for="{{taskProgress}}" wx:key="id" class="progress-item" bindtap="viewTaskDetail" data-id="{{item.id}}">
          <view class="progress-course">{{item.title}}</view>
          <view class="progress-bar-bg">
            <view class="progress-bar" style="width: {{item.progress}}%"></view>
          </view>
          <view class="progress-text">
            <text>已完成 {{item.progress}}%</text>
            <text class="progress-status {{item.status === 'urgent' ? 'urgent' : item.status === 'completed' ? 'completed' : ''}}">
              {{item.status === 'urgent' ? '紧急' : item.status === 'completed' ? '已完成' : '进行中'}}
            </text>
          </view>
        </view>
        
        <!-- 任务未完成提示 -->
        <view wx:if="{{hasUncompletedTasks}}" class="task-reminder {{reminderType}}" bindtap="viewAllTasks">
          <view class="reminder-icon">!</view>
          <view class="reminder-text">{{reminderText}}</view>
        </view>
      </view>
    </view>
  </block>
  
  <!-- 工作室概览 -->
  <view class="section-title">工作室概览</view>
  <view class="overview-card card">
    <view class="overview-title">
      <text>工作室活跃度趋势</text>
      <view class="title-right">
        <text class="chart-period-title">近5天</text>
        <view class="info-icon" bindtap="showCalculationInfo">
          <t-icon name="help" size="32rpx" color="#999"></t-icon>
        </view>
      </view>
    </view>
    
    <view class="chart-area">
      <canvas wx:if="{{hasChartData && !showCalculationModal}}" canvas-id="lineChart" disable-scroll="true" class="chart-canvas" bindtouchstart="onTouchStart" bindtouchmove="onTouchMove" bindtouchend="onTouchEnd"></canvas>
      <view wx:else class="chart-empty">
        <t-icon name="chart-line" size="80rpx" color="#ddd"></t-icon>
        <text class="empty-text">暂无活跃度数据</text>
      </view>
    </view>
  </view>
  
  <!-- 管理模块 - 根据角色显示不同模块 -->
  <view class="section-title">{{(role === 'admin' || role === 'teacher') ? '管理模块' : '功能模块'}}</view>
  <view class="modules-grid card">
    <!-- 通用模块 -->
    <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="course">
      <t-icon name="education" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
      <text class="module-name">{{role === 'student' ? '我的课程' : '课程管理'}}</text>
    </view>
    
    <!-- 学生模块 -->
    <block wx:if="{{role === 'student'}}">
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="schedule">
        <t-icon name="calendar" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
        <text class="module-name">值班表</text>
      </view>
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="task">
        <t-icon name="task" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
        <text class="module-name">我的任务</text>
      </view>
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="attendance">
        <t-icon name="time" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
        <text class="module-name">我的考勤</text>
      </view>
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="material">
        <t-icon name="folder" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
        <text class="module-name">资料库</text>
      </view>
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="achievement">
        <t-icon name="star" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
        <text class="module-name">我的成就</text>
      </view>
    </block>
    
    <!-- 老师模块：具有部分管理权限 -->
    <block wx:if="{{role === 'teacher'}}">
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="schedule">
        <t-icon name="calendar" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
        <text class="module-name">值班表</text>
      </view>
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="approval">
        <view class="module-icon-wrapper">
          <t-icon name="check-circle" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
          <view class="approval-badge" wx:if="{{approvalStats.totalPendingApprovals > 0}}">
            {{approvalStats.totalPendingApprovals}}
          </view>
        </view>
        <text class="module-name">审批中心</text>
      </view>
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="material">
        <t-icon name="folder" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
        <text class="module-name">资料库</text>
      </view>
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="achievement">
        <t-icon name="star" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
        <text class="module-name">我的成就</text>
      </view>
    </block>
    
    <!-- 管理员模块 -->
    <block wx:if="{{role === 'admin'}}">
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="user">
        <t-icon name="usergroup" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
        <text class="module-name">人员管理</text>
      </view>
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="approval">
        <view class="module-icon-wrapper">
          <t-icon name="check-circle" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
          <view class="approval-badge" wx:if="{{approvalStats.totalPendingApprovals > 0}}">
            {{approvalStats.totalPendingApprovals}}
          </view>
        </view>
        <text class="module-name">审批中心</text>
      </view>
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="attendance">
        <t-icon name="user-time" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
        <text class="module-name">考勤管理</text>
      </view>
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="announcement">
        <t-icon name="sound" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
        <text class="module-name">公告管理</text>
      </view>
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="material">
        <t-icon name="folder-open" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
        <text class="module-name">资料管理</text>
      </view>
      <view class="module-item" hover-class="item-hover" hover-stay-time="100" bindtap="navigateToModule" data-id="schedule">
        <t-icon name="calendar" size="80rpx" color="#0052d9" class="module-icon"></t-icon>
        <text class="module-name">值班表</text>
      </view>
    </block>
  </view>
</view>

<!-- 计算说明弹窗 -->
<t-popup visible="{{showCalculationModal}}" placement="bottom" z-index="99999" prevent-scroll-through="true" show-overlay="true" bind:visible-change="onCalculationModalChange">
  <view class="calculation-modal-bottom">
    <view class="modal-header">
      <text class="modal-title">活跃度计算说明</text>
      <view class="modal-close" bindtap="hideCalculationModal">
        <t-icon name="close" size="40rpx" color="#999"></t-icon>
      </view>
    </view>
    
    <scroll-view class="modal-body" scroll-y="true" enable-flex="true">
      <view class="calculation-section">
        <text class="section-title">活跃度指标</text>
        <text class="section-content">工作室活跃度由以下几个维度综合计算：</text>
        
        <view class="metric-item">
          <text class="metric-name">• 签到活跃度 (40%)</text>
          <text class="metric-desc">基于每日签到人数占总人数的比例</text>
        </view>
        
        <view class="metric-item">
          <text class="metric-name">• 任务参与度 (30%)</text>
          <text class="metric-desc">当日提交任务和完成任务的人数比例</text>
        </view>
        
        <view class="metric-item">
          <text class="metric-name">• 课程互动度 (20%)</text>
          <text class="metric-desc">课程讨论、资料下载等互动行为频次</text>
        </view>
        
        <view class="metric-item">
          <text class="metric-name">• 系统使用度 (10%)</text>
          <text class="metric-desc">小程序日活跃用户占比</text>
        </view>
      </view>
      
      <view class="calculation-section">
        <text class="section-title"> 计算公式</text>
        <view class="formula-box">
          <text class="formula">活跃度 = 签到率×0.4 + 任务参与率×0.3 + 课程互动率×0.2 + 系统使用率×0.1</text>
        </view>
      </view>
      
      <view class="calculation-section">
        <text class="section-title"> 更新频率</text>
        <text class="section-content">数据每日凌晨2点自动更新，图表展示近5天的趋势变化。</text>
      </view>
    </scroll-view>
  </view>
</t-popup>

 