<!--pages/materials/index.wxml-->
<view class="materials-container">
  <!-- 搜索栏 -->
  <view class="search-section">
    <view class="search-bar {{searchFocused ? 'search-focused' : ''}}">
      <t-icon name="search" size="32rpx" color="#999" />
      <input 
        class="search-input" 
        placeholder="搜索资料名称..." 
        value="{{searchQuery}}"
        bindinput="onSearchInput"
        bindconfirm="onSearchConfirm"
        bindfocus="onSearchFocus"
        bindblur="onSearchBlur"
        confirm-type="search"
      />
      <view wx:if="{{searchQuery}}" class="search-clear" bindtap="clearSearch">
        <t-icon name="close-circle" size="32rpx" color="#999" />
      </view>
    </view>
    
    <!-- 筛选按钮 -->
    <view class="filter-btn" bindtap="showFilter">
      <t-icon name="filter" size="32rpx" color="#666" />
      <text class="filter-text">筛选</text>
    </view>
  </view>

  <!-- 搜索结果提示 -->
  <view wx:if="{{showSearchResult}}" class="search-result-tip">
    <text class="result-text">搜索"{{searchQuery}}"的结果</text>
    <text class="result-count">共 {{total}} 条</text>
  </view>

  <!-- 快速分类筛选 -->
  <scroll-view wx:if="{{categories.length > 1}}" class="quick-filter" scroll-x enable-flex>
    <view 
      wx:for="{{categories}}" 
      wx:key="id"
      class="filter-chip {{selectedCategory && selectedCategory.id === item.id ? 'active' : ''}}"
      bindtap="onCategoryPickerChange"
      data-value="{{index}}"
    >
      {{item.name}}
    </view>
  </scroll-view>

  <!-- 资料列表 -->
  <view class="materials-list">
    <!-- 加载状态 -->
    <view wx:if="{{loading}}" class="loading-container">
      <t-loading theme="circular" size="60rpx" text="加载中..." />
    </view>

    <!-- 空状态 -->
    <view wx:elif="{{materials.length === 0}}" class="empty-container">
      <t-empty 
        icon="file" 
        description="{{showSearchResult ? '没有找到相关资料' : '暂无资料'}}"
      >
        <t-button wx:if="{{showSearchResult}}" slot="action" variant="text" bindtap="clearSearch">
          清除搜索
        </t-button>
      </t-empty>
    </view>

    <!-- 资料卡片列表 -->
    <view wx:else class="material-cards">
      <view 
        wx:for="{{materials}}" 
        wx:key="id"
        class="material-card"
        bindtap="viewMaterialDetail"
        data-id="{{item.id}}"
      >
        <!-- 资料卡片头部 -->
        <view class="card-header">
                  <view class="file-info">
          <view class="file-icon">
            <t-icon name="{{item.fileTypeIcon}}" size="48rpx" color="#4A90E2" />
          </view>
          <view class="file-details">
            <text class="file-name">{{item.fileName}}</text>
            <view class="file-meta">
              <text class="file-size">{{item.formattedSize}}</text>
              <text class="file-separator">•</text>
              <text class="file-time">{{item.formattedUploadTime}}</text>
            </view>
          </view>
        </view>
          
          <!-- 操作按钮 -->
          <view class="action-buttons">
            <view 
              class="action-btn preview-btn"
              catchtap="previewMaterial"
              data-url="{{item.url}}"
              data-filename="{{item.fileName}}"
              data-id="{{item.id}}"
            >
              <t-icon name="view-module" size="32rpx" color="#4A90E2" />
            </view>
            <view 
              class="action-btn download-btn"
              catchtap="downloadMaterial"
              data-url="{{item.url}}"
              data-filename="{{item.fileName}}"
              data-id="{{item.id}}"
            >
              <t-icon name="download" size="32rpx" color="#50C878" />
            </view>
          </view>
        </view>

        <!-- 资料描述 -->
        <view wx:if="{{item.description}}" class="card-description">
          <text class="description-text">{{item.description}}</text>
        </view>

        <!-- 资料底部信息 -->
        <view class="card-footer">
          <view class="category-tag" wx:if="{{item.categoryName}}">
            <text class="category-text">{{item.categoryName}}</text>
          </view>
          
          <view class="stats">
            <view class="stat-item">
              <t-icon name="download" size="24rpx" color="#999" />
              <text class="stat-text">{{item.downloadCount || 0}}</text>
            </view>
            <view class="stat-item">
              <t-icon name="user" size="24rpx" color="#999" />
              <text class="stat-text">{{item.uploader || '未知'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 加载更多 -->
    <view wx:if="{{hasMore && materials.length > 0}}" class="load-more">
      <view wx:if="{{loadingMore}}" class="loading-more">
        <t-loading theme="dots" size="40rpx" />
        <text class="loading-text">正在加载更多...</text>
      </view>
      <text wx:else class="load-more-text">上拉加载更多</text>
    </view>

    <!-- 没有更多数据 -->
    <view wx:if="{{!hasMore && materials.length > 0}}" class="no-more">
      <text class="no-more-text">已显示全部 {{materials.length}} 条资料</text>
    </view>
  </view>
</view>

<!-- 筛选弹窗 -->
<t-popup visible="{{showFilterModal}}" placement="bottom" bind:visible-change="hideFilter">
  <view class="filter-modal" catchtouchmove="preventTouchMove">
    <view class="filter-header">
      <text class="filter-title">筛选条件</text>
      <view class="filter-actions">
        <text class="reset-btn" bindtap="resetFilter">重置</text>
        <text class="apply-btn" bindtap="applyFilter">应用</text>
      </view>
    </view>

    <view class="filter-content">
      <!-- 分类筛选 -->
      <view class="filter-group">
        <text class="filter-label">资料分类</text>
        <view class="filter-option" bindtap="showCategoryPicker">
          <text class="option-text">{{selectedCategory ? selectedCategory.name : '请选择分类'}}</text>
          <t-icon name="chevron-right" size="32rpx" color="#999" />
        </view>
      </view>

      <!-- 文件类型筛选 -->
      <view class="filter-group">
        <text class="filter-label">文件类型</text>
        <view class="filter-option" bindtap="showFileTypePicker">
          <text class="option-text">{{selectedFileType ? selectedFileType : '全部类型'}}</text>
          <t-icon name="chevron-right" size="32rpx" color="#999" />
        </view>
      </view>
    </view>
  </view>
</t-popup>

<!-- 分类选择器 -->
<t-picker
  visible="{{showCategoryPicker}}"
  value="{{[categoryPickerIndex]}}"
  title="选择分类"
  cancelBtn="取消"
  confirmBtn="确定"
  bindchange="onCategoryPickerChange"
  bindcancel="onCategoryPickerCancel"
>
  <t-picker-item options="{{categories}}" />
</t-picker>

<!-- 文件类型选择器 -->
<t-picker
  visible="{{showFileTypePicker}}"
  value="{{[fileTypePickerIndex]}}"
  title="选择文件类型"
  cancelBtn="取消"
  confirmBtn="确定"
  bindchange="onFileTypePickerChange"
  bindcancel="onFileTypePickerCancel"
>
  <t-picker-item options="{{fileTypes}}" />
</t-picker> 