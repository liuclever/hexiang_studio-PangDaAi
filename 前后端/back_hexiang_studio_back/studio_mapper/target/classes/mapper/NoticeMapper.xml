<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.back_hexiang_studio.mapper.NoticeMapper">

    <!-- 新增公告 -->
    <insert id="add" parameterType="com.back_hexiang_studio.dv.dto.NoticeDto" useGeneratedKeys="true" keyProperty="noticeId">
        insert into notice ( title,content,publisher,publishTime,status,type)
        values (#{title},#{content},#{publisher},#{publishTime},#{status},#{type})
    </insert>

    <!-- 更新公告 -->
    <update id="update" parameterType="com.back_hexiang_studio.dv.dto.NoticeDto">
        update notice
        set title=#{title},
            content=#{content},
            publisher=#{publisher},
            publishTime=#{publishTime},
            status=#{status},
            type=#{type}
        where noticeId=#{noticeId}
    </update>

    <!-- 批量删除公告 -->
    <delete id="delete">
        delete from notice where noticeId in
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 分页查询公告列表 -->
    <select id="list" resultType="com.back_hexiang_studio.dv.vo.NoticeVo">
        select
            n.noticeId, n.title, n.content,
            DATE_FORMAT(n.publishTime, '%Y-%m-%d %H:%i:%s') as publishTime,
            n.status, n.type,
            DATE_FORMAT(n.create_time, '%Y-%m-%d %H:%i:%s') as createTime,
            DATE_FORMAT(n.update_time, '%Y-%m-%d %H:%i:%s') as updateTime,
            n.publisher,
            u.name as publisherName
        from
            notice n
        left join
            user u on CAST(n.publisher AS UNSIGNED) = u.user_id
        <where>
            <if test="title != null and title != ''">
                and n.title like concat('%',#{title},'%')
            </if>
            <if test="type != null and type != ''">
                and n.type = #{type}
            </if>
            <if test="status != null and status != ''">
                and n.status = #{status}
            </if>
            <if test="beginTime != null and beginTime != ''">
                and (n.publishTime &gt;= #{beginTime} OR n.publishTime IS NULL)
            </if>
            <if test="endTime != null and endTime != ''">
                and (n.publishTime &lt;= #{endTime} OR n.publishTime IS NULL)
            </if>
        </where>
        order by n.publishTime desc
    </select>
    
    <!-- 获取最近发布的10条系统公告 -->
    <select id="getRecentNotices" resultMap="noticeWithImageResultMap">
        SELECT 
            n.noticeId, n.title, n.content, 
            DATE_FORMAT(n.publishTime, '%Y-%m-%d %H:%i:%s') as publishTime,
            n.status, n.type, n.publisher,
            u.name as publisherName,
            ni.image_id, ni.image_name, ni.image_path, ni.image_size, ni.image_type
        FROM
            notice n
        LEFT JOIN
            user u ON CAST(n.publisher AS UNSIGNED) = u.user_id
        LEFT JOIN
            (SELECT notice_id, MIN(image_id) as min_image_id FROM notice_image GROUP BY notice_id) as first_img 
            ON n.noticeId = first_img.notice_id
        LEFT JOIN
            notice_image ni ON first_img.min_image_id = ni.image_id
        WHERE 
            n.status = 1 AND n.publishTime >= DATE_SUB(NOW(), INTERVAL 1 MONTH) 
        ORDER BY 
            n.publishTime DESC 
        LIMIT 10
    </select>
    
    <!-- 获取最近发布的活动公告 -->
    <select id="getRecentActivityNotices" resultType="com.back_hexiang_studio.dv.vo.NoticeVo">
        select
            n.noticeId, n.title, n.content, 
            DATE_FORMAT(n.publishTime, '%Y-%m-%d %H:%i:%s') as publishTime,
            n.status, n.type,
            u.name as publisherName
        from
            notice n
        left join
            user u on CAST(n.publisher AS UNSIGNED) = u.user_id
        WHERE n.status = 1 AND n.type = 1 AND n.publishTime >= DATE_SUB(NOW(), INTERVAL 1 MONTH) 
        ORDER BY n.publishTime DESC
    </select>
    
    <!-- 获取最近发布的所有公告 -->
    <select id="getAllRecentNotices" resultType="com.back_hexiang_studio.dv.vo.NoticeVo">
        select
            n.noticeId, n.title, n.content,
            DATE_FORMAT(n.publishTime, '%Y-%m-%d %H:%i:%s') as publishTime,
            n.status, n.type,
            u.name as publisherName
        from
            notice n
        left join
            user u on CAST(n.publisher AS UNSIGNED) = u.user_id
        WHERE n.status = 1 AND n.publishTime >= DATE_SUB(NOW(), INTERVAL 1 MONTH) 
        ORDER BY n.publishTime DESC
    </select>
    
    <!-- 根据ID获取公告详情 -->
    <select id="getById" resultType="com.back_hexiang_studio.dv.vo.NoticeVo">
        select
            n.noticeId, n.title, n.content, 
            DATE_FORMAT(n.publishTime, '%Y-%m-%d %H:%i:%s') as publishTime,
            n.status, n.type,
            DATE_FORMAT(n.create_time, '%Y-%m-%d %H:%i:%s') as createTime,
            DATE_FORMAT(n.update_time, '%Y-%m-%d %H:%i:%s') as updateTime,
            n.publisher,
            u.name as publisherName
        from
            notice n
        left join
            user u on CAST(n.publisher AS UNSIGNED) = u.user_id
        WHERE n.noticeId = #{id}
    </select>
    
    <!-- (实体类)新增公告 - 用于MyBatis-Plus自动填充 -->
    <insert id="insert" parameterType="com.back_hexiang_studio.entity.Notice" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO notice (title, content, status, type, create_user, update_user, publishTime, create_time, update_time)
        VALUES (#{title}, #{content}, #{status}, #{type}, #{createUser}, #{updateUser}, #{publishDate}, #{createTime}, #{updateTime})
    </insert>

    <!-- 定义结果映射，处理公告及其图片信息 -->
    <resultMap id="noticeWithImageResultMap" type="com.back_hexiang_studio.dv.vo.NoticeVo">
        <id property="noticeId" column="noticeId"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="publisher" column="publisher"/>
        <result property="publishTime" column="publishTime"/>
        <result property="status" column="status"/>
        <result property="type" column="type"/>
        <result property="publisherName" column="publisherName"/>
        <collection property="images" ofType="com.back_hexiang_studio.dv.vo.NoticeImageVo">
            <id property="imageId" column="image_id"/>
            <result property="fileName" column="image_name"/>
            <result property="filePath" column="image_path"/>
            <result property="fileSize" column="image_size"/>
            <result property="fileType" column="image_type"/>
        </collection>
    </resultMap>

</mapper>

